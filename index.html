<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choice Properties - Rental Application</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a5276;
            --secondary: #3498db;
            --accent: #e67e22;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ed 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 25px 30px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(40%, -40%);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo i {
            font-size: 32px;
            color: var(--accent);
        }

        .logo-text {
            font-size: 28px;
            font-weight: 700;
        }

        .tagline {
            font-size: 16px;
            opacity: 0.9;
            margin-left: 47px;
        }

        .progress-container {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin: 25px 0;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            height: 6px;
            background-color: #e0e0e0;
            z-index: 1;
            border-radius: 3px;
        }

        .progress-fill {
            position: absolute;
            top: 20px;
            left: 0;
            height: 6px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            z-index: 2;
            border-radius: 3px;
            transition: var(--transition);
            width: 0%;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 3;
        }

        .step-number {
            background-color: white;
            color: var(--dark);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 3px solid #e0e0e0;
            transition: var(--transition);
        }

        .step-label {
            margin-top: 10px;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            text-align: center;
            transition: var(--transition);
        }

        .progress-step.active .step-number {
            background-color: var(--secondary);
            color: white;
            border-color: var(--secondary);
            transform: scale(1.1);
        }

        .progress-step.active .step-label {
            color: var(--secondary);
            font-weight: 700;
        }

        .progress-step.completed .step-number {
            background-color: var(--success);
            color: white;
            border-color: var(--success);
        }

        .form-container {
            background-color: white;
            padding: 30px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .form-section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .form-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h2 i {
            color: var(--accent);
        }

        h3 {
            color: var(--secondary);
            margin: 20px 0 15px;
            padding-left: 10px;
            border-left: 4px solid var(--secondary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .required::after {
            content: " *";
            color: var(--danger);
        }

        .required-note {
            font-size: 14px;
            color: var(--danger);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        input.error, select.error, textarea.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-col {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox-group input {
            width: auto;
        }

        .privacy-note {
            background-color: #e8f4fc;
            border-left: 4px solid var(--secondary);
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .legal-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .legal-section h3 {
            margin-top: 0;
            border-left: none;
            padding-left: 0;
        }

        .btn-container {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-prev {
            background-color: #e9ecef;
            color: var(--dark);
        }

        .btn-next, .btn-submit {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
        }

        .btn-prev:hover {
            background-color: #dee2e6;
            transform: translateY(-2px);
        }

        .btn-next:hover, .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-submit {
            background: linear-gradient(to right, var(--success), #2ecc71);
        }

        .error-message {
            color: var(--danger);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .success-message {
            background: linear-gradient(to right, #d4edda, #c3e6cb);
            color: #155724;
            padding: 30px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            text-align: center;
            display: none;
            box-shadow: var(--shadow);
        }

        .success-message i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--success);
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
        }

        .confidential-stamp {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: var(--accent);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            transform: rotate(5deg);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .time-estimate {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
            display: inline-block;
        }

        .character-count {
            font-size: 12px;
            color: #7f8c8d;
            text-align: right;
            margin-top: 5px;
        }

        .character-count.warning {
            color: var(--warning);
        }

        .character-count.error {
            color: var(--danger);
        }

        .file-upload {
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: var(--secondary);
            background-color: #f8f9fa;
        }

        .file-upload i {
            font-size: 36px;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .file-list {
            margin-top: 15px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
        }

        .file-item .file-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-item .file-remove {
            color: var(--danger);
            cursor: pointer;
        }

        .co-applicant-section {
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }

        .co-applicant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .remove-co-applicant {
            color: var(--danger);
            cursor: pointer;
            background: none;
            border: none;
            font-size: 18px;
        }

        .add-co-applicant {
            background-color: var(--light);
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 20px;
        }

        .add-co-applicant:hover {
            border-color: var(--secondary);
            background-color: #e8f4fc;
        }

        .summary-section {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .summary-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .summary-label {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .summary-value {
            color: #555;
        }

        .payment-section {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
        }

        .payment-options {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .payment-option {
            flex: 1;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .payment-option.selected {
            border-color: var(--secondary);
            background-color: #e8f4fc;
        }

        .payment-option i {
            font-size: 24px;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .save-progress {
            text-align: center;
            margin: 20px 0;
        }

        .save-progress-btn {
            background: linear-gradient(to right, #6c757d, #868e96);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* SSN masking styles */
        .ssn-container {
            position: relative;
        }

        .ssn-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            font-size: 14px;
        }

        .ssn-toggle:hover {
            color: var(--primary);
        }

        .field-hint {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .btn-container {
                flex-direction: column;
                gap: 10px;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }
            
            .progress-bar {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .progress-step {
                flex: 1;
                min-width: 80px;
            }
            
            .payment-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="confidential-stamp">
                <i class="fas fa-lock"></i> CONFIDENTIAL & SECURE
            </div>
            <div class="logo">
                <i class="fas fa-building"></i>
                <div class="logo-text">Choice Properties</div>
            </div>
            <div class="tagline">Professional Property Management Solutions</div>
            <div class="time-estimate">
                <i class="fas fa-clock"></i> Estimated time: 15-20 minutes
            </div>
        </header>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
                <div class="progress-step completed" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-label">Property & Applicant</div>
                </div>
                <div class="progress-step active" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-label">Residency & Occupancy</div>
                </div>
                <div class="progress-step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-label">Employment & Income</div>
                </div>
                <div class="progress-step" id="step4">
                    <div class="step-number">4</div>
                    <div class="step-label">Financial & References</div>
                </div>
                <div class="progress-step" id="step5">
                    <div class="step-number">5</div>
                    <div class="step-label">Review & Submit</div>
                </div>
            </div>
        </div>

        <div class="form-container">
            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i>
                <h2>Application Submitted Successfully!</h2>
                <p>Thank you for choosing Choice Properties. We have received your rental application and will review it carefully.</p>
                <p>You can expect to hear from us within 2-3 business days.</p>
                <button class="btn-submit" onclick="window.print()" style="margin-top: 20px;">
                    <i class="fas fa-print"></i> Print Application Summary
                </button>
            </div>

            <form id="rentalApplication">
                <!-- Section 1: Property & Applicant Information -->
                <div class="form-section active" id="section1">
                    <h2><i class="fas fa-home"></i> Property & Applicant Information</h2>
                    
                    <div class="required-note">
                        <i class="fas fa-info-circle"></i> Fields marked with * are required
                    </div>
                    
                    <div class="legal-section">
                        <h3><i class="fas fa-shield-alt"></i> Notice to Applicants & Privacy Policy</h3>
                        <p>Choice Properties is committed to providing equal housing opportunities and fully complies with the Federal Fair Housing Act. We do not discriminate based on race, color, religion, sex, national origin, familial status, disability, or any other state or locally protected class.</p>
                        <p>All information provided is confidential and will only be used for rental screening and verification purposes. Sensitive data such as SSN and ID numbers will be securely stored and encrypted in compliance with data protection regulations.</p>
                    </div>
                    
                    <h3>Property Information</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="propertyAddress" class="required">Property Address</label>
                            <input type="text" id="propertyAddress" name="propertyAddress" placeholder="123 Main Street" required>
                            <div class="error-message" id="propertyAddressError">Please enter the property address</div>
                        </div>
                        <div class="form-col">
                            <label for="unitNumber">Unit Number</label>
                            <input type="text" id="unitNumber" name="unitNumber" placeholder="Apt 4B">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="moveInDate" class="required">Requested Move-In Date</label>
                            <input type="date" id="moveInDate" name="moveInDate" required>
                            <div class="error-message" id="moveInDateError">Please select a move-in date</div>
                        </div>
                        <div class="form-col">
                            <label for="leaseTerm" class="required">Lease Term</label>
                            <select id="leaseTerm" name="leaseTerm" required>
                                <option value="">Select Term</option>
                                <option value="6 months">6 Months</option>
                                <option value="12 months" selected>12 Months</option>
                                <option value="18 months">18 Months</option>
                                <option value="24 months">24 Months</option>
                            </select>
                            <div class="error-message" id="leaseTermError">Please select a lease term</div>
                        </div>
                    </div>
                    
                    <h3>Primary Applicant Information</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="fullName" class="required">Full Legal Name</label>
                            <input type="text" id="fullName" name="fullName" placeholder="John A. Smith" required>
                            <div class="error-message" id="fullNameError">Please enter your full legal name</div>
                        </div>
                        <div class="form-col">
                            <label for="dob" class="required">Date of Birth</label>
                            <input type="date" id="dob" name="dob" required>
                            <div class="error-message" id="dobError">Please enter your date of birth</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="ssn-container">
                                <label for="ssn" class="required">Social Security Number</label>
                                <input type="password" id="ssn" name="ssn" placeholder="XXX-XX-XXXX" required maxlength="11">
                                <button type="button" class="ssn-toggle" id="ssnToggle">
                                    <i class="fas fa-eye"></i> Show
                                </button>
                            </div>
                            <div class="field-hint">Format: XXX-XX-XXXX (9 digits total)</div>
                            <div class="error-message" id="ssnError">Please enter a valid SSN in format XXX-XX-XXXX (9 digits)</div>
                            <div class="privacy-note">
                                <i class="fas fa-lock"></i> Your SSN will be encrypted and stored securely for verification purposes only.
                            </div>
                        </div>
                        <div class="form-col">
                            <label for="dlNumber" class="required">Driver's License / State ID Number</label>
                            <input type="text" id="dlNumber" name="dlNumber" required>
                            <div class="error-message" id="dlNumberError">Please enter your driver's license or state ID number</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="dlState" class="required">Issuing State</label>
                            <select id="dlState" name="dlState" required>
                                <option value="">Select State</option>
                            </select>
                            <div class="error-message" id="dlStateError">Please select the issuing state</div>
                        </div>
                        <div class="form-col">
                            <label for="phone" class="required">Primary Phone Number</label>
                            <input type="tel" id="phone" name="phone" placeholder="(555) 123-4567" required maxlength="14">
                            <div class="field-hint">Format: (XXX) XXX-XXXX (10 digits total)</div>
                            <div class="error-message" id="phoneError">Please enter a valid 10-digit phone number</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="email" class="required">Email Address</label>
                            <input type="email" id="email" name="email" placeholder="your.email@example.com" required>
                            <div class="error-message" id="emailError">Please enter a valid email address</div>
                        </div>
                        <div class="form-col">
                            <label for="maritalStatus">Marital Status</label>
                            <select id="maritalStatus" name="maritalStatus">
                                <option value="">Select Status</option>
                                <option value="Single">Single</option>
                                <option value="Married">Married</option>
                                <option value="Divorced">Divorced</option>
                                <option value="Widowed">Widowed</option>
                                <option value="Separated">Separated</option>
                            </select>
                        </div>
                    </div>
                    
                    <h3>Co-Applicants</h3>
                    <div class="add-co-applicant" id="addCoApplicant">
                        <i class="fas fa-user-plus"></i>
                        <div>Add Co-Applicant</div>
                    </div>
                    
                    <div id="coApplicantsContainer"></div>
                    
                    <div class="save-progress">
                        <button type="button" class="save-progress-btn" id="saveProgressBtn">
                            <i class="fas fa-save"></i> Save Progress & Continue Later
                        </button>
                    </div>
                    
                    <div class="btn-container">
                        <div></div>
                        <button type="button" class="btn-next" onclick="nextSection(1)">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Section 2: Residency & Occupancy -->
                <div class="form-section" id="section2">
                    <h2><i class="fas fa-users"></i> Residency & Occupancy Information</h2>
                    
                    <h3>Occupancy Details</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="numOccupants" class="required">Total Number of Occupants</label>
                            <input type="number" id="numOccupants" name="numOccupants" min="1" value="1" required>
                            <div class="error-message" id="numOccupantsError">Please enter the number of occupants</div>
                        </div>
                        <div class="form-col">
                            <label for="occupantsList" class="required">List All Occupants (Including Minors) & Ages</label>
                            <textarea id="occupantsList" name="occupantsList" rows="3" placeholder="John Smith (35), Jane Smith (33), Emily Smith (5)" maxlength="500" required></textarea>
                            <div class="character-count" id="occupantsListCount">0/500 characters</div>
                            <div class="error-message" id="occupantsListError">Please list all occupants and their ages</div>
                        </div>
                    </div>
                    
                    <h3>Pet Information</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="hasPets" name="hasPets">
                        <label for="hasPets">Do you have any pets?</label>
                    </div>
                    
                    <div id="petDetails" style="display: none;">
                        <div class="form-row">
                            <div class="form-col">
                                <label for="petType">Type of Pet</label>
                                <input type="text" id="petType" name="petType" placeholder="Dog, Cat, etc.">
                            </div>
                            <div class="form-col">
                                <label for="petBreed">Breed</label>
                                <input type="text" id="petBreed" name="petBreed" placeholder="Labrador, Siamese, etc.">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <label for="petWeight">Weight (lbs)</label>
                                <input type="number" id="petWeight" name="petWeight" min="1" placeholder="50">
                            </div>
                            <div class="form-col">
                                <label for="petAge">Age</label>
                                <input type="number" id="petAge" name="petAge" min="0" placeholder="3">
                            </div>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="hasServiceAnimal" name="hasServiceAnimal">
                        <label for="hasServiceAnimal">Do you have a service/assistance animal?</label>
                    </div>
                    
                    <div id="serviceAnimalDetails" style="display: none;">
                        <div class="form-group">
                            <label for="serviceAnimalTask">Describe the work/task the animal performs</label>
                            <textarea id="serviceAnimalTask" name="serviceAnimalTask" rows="3" placeholder="Please describe the specific tasks or work performed by the animal..." maxlength="500"></textarea>
                            <div class="character-count" id="serviceAnimalTaskCount">0/500 characters</div>
                            <div class="privacy-note">
                                <i class="fas fa-info-circle"></i> Note: A request for a reasonable accommodation for a service/assistance animal is not a pet and is subject to a separate review process.
                            </div>
                        </div>
                    </div>
                    
                    <h3>Current Residence</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="currentAddress" class="required">Address</label>
                            <input type="text" id="currentAddress" name="currentAddress" placeholder="456 Oak Avenue" required>
                            <div class="error-message" id="currentAddressError">Please enter your current address</div>
                        </div>
                        <div class="form-col">
                            <label for="currentCity" class="required">City</label>
                            <input type="text" id="currentCity" name="currentCity" placeholder="Springfield" required>
                            <div class="error-message" id="currentCityError">Please enter your current city</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="currentState" class="required">State</label>
                            <select id="currentState" name="currentState" required>
                                <option value="">Select State</option>
                            </select>
                            <div class="error-message" id="currentStateError">Please select your current state</div>
                        </div>
                        <div class="form-col">
                            <label for="currentZip" class="required">ZIP Code</label>
                            <input type="text" id="currentZip" name="currentZip" placeholder="12345" required>
                            <div class="error-message" id="currentZipError">Please enter your current ZIP code</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="currentLandlord" class="required">Landlord/Property Manager Name</label>
                            <input type="text" id="currentLandlord" name="currentLandlord" placeholder="Robert Johnson" required>
                            <div class="error-message" id="currentLandlordError">Please enter your landlord's name</div>
                        </div>
                        <div class="form-col">
                            <label for="currentLandlordContact" class="required">Landlord Contact (Phone/Email)</label>
                            <input type="text" id="currentLandlordContact" name="currentLandlordContact" placeholder="(555) 987-6543 or r.johnson@example.com" required>
                            <div class="error-message" id="currentLandlordContactError">Please enter your landlord's contact information</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="currentResidenceDates" class="required">Dates of Residence</label>
                            <input type="text" id="currentResidenceDates" name="currentResidenceDates" placeholder="MM/YYYY - MM/YYYY" required>
                            <div class="error-message" id="currentResidenceDatesError">Please enter your dates of residence</div>
                        </div>
                        <div class="form-col">
                            <label for="currentRent" class="required">Monthly Rent Amount</label>
                            <input type="number" id="currentRent" name="currentRent" min="0" placeholder="1500" required>
                            <div class="error-message" id="currentRentError">Please enter your monthly rent amount</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="currentReasonLeaving" class="required">Reason for Leaving</label>
                        <textarea id="currentReasonLeaving" name="currentReasonLeaving" rows="2" placeholder="Relocating for work, need more space, etc." maxlength="300" required></textarea>
                        <div class="character-count" id="currentReasonLeavingCount">0/300 characters</div>
                        <div class="error-message" id="currentReasonLeavingError">Please provide a reason for leaving</div>
                    </div>
                    
                    <h3>Previous Residence (if less than 2 years at current address)</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="previousAddress">Previous Address</label>
                            <input type="text" id="previousAddress" name="previousAddress" placeholder="789 Pine Street">
                        </div>
                        <div class="form-col">
                            <label for="previousCity">City</label>
                            <input type="text" id="previousCity" name="previousCity" placeholder="Riverside">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="previousState">State</label>
                            <select id="previousState" name="previousState">
                                <option value="">Select State</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="previousZip">ZIP Code</label>
                            <input type="text" id="previousZip" name="previousZip" placeholder="54321">
                        </div>
                    </div>
                    
                    <div class="save-progress">
                        <button type="button" class="save-progress-btn" id="saveProgressBtn2">
                            <i class="fas fa-save"></i> Save Progress & Continue Later
                        </button>
                    </div>
                    
                    <div class="btn-container">
                        <button type="button" class="btn-prev" onclick="prevSection(2)">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button type="button" class="btn-next" onclick="nextSection(2)">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Section 3: Employment & Income -->
                <div class="form-section" id="section3">
                    <h2><i class="fas fa-briefcase"></i> Employment & Income Information</h2>
                    
                    <h3>Current Employment</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="employerName" class="required">Employer Name</label>
                            <input type="text" id="employerName" name="employerName" placeholder="ABC Corporation" required>
                            <div class="error-message" id="employerNameError">Please enter your employer's name</div>
                        </div>
                        <div class="form-col">
                            <label for="employerAddress" class="required">Employer Address</label>
                            <input type="text" id="employerAddress" name="employerAddress" placeholder="789 Business Blvd, Suite 100" required>
                            <div class="error-message" id="employerAddressError">Please enter your employer's address</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="position" class="required">Position/Title</label>
                            <input type="text" id="position" name="position" placeholder="Software Engineer" required>
                            <div class="error-message" id="positionError">Please enter your position/title</div>
                        </div>
                        <div class="form-col">
                            <label for="supervisorName" class="required">Supervisor Name</label>
                            <input type="text" id="supervisorName" name="supervisorName" placeholder="Sarah Williams" required>
                            <div class="error-message" id="supervisorNameError">Please enter your supervisor's name</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="supervisorContact" class="required">Supervisor Contact (Phone/Email)</label>
                            <input type="text" id="supervisorContact" name="supervisorContact" placeholder="(555) 246-8137 or s.williams@abccorp.com" required>
                            <div class="error-message" id="supervisorContactError">Please enter your supervisor's contact information</div>
                        </div>
                        <div class="form-col">
                            <label for="employmentStart" class="required">Employment Start Date</label>
                            <input type="date" id="employmentStart" name="employmentStart" required>
                            <div class="error-message" id="employmentStartError">Please enter your employment start date</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="income" class="required">Monthly/Annual Income</label>
                            <input type="number" id="income" name="income" min="0" placeholder="5000" required>
                            <div class="error-message" id="incomeError">Please enter your income</div>
                        </div>
                        <div class="form-col">
                            <label for="incomeType">Income Type</label>
                            <select id="incomeType" name="incomeType">
                                <option value="Monthly" selected>Monthly</option>
                                <option value="Annual">Annual</option>
                            </select>
                        </div>
                    </div>
                    
                    <h3>Other Income Sources</h3>
                    <div class="form-group">
                        <label for="otherIncome">Please list any other income sources (alimony, child support, investments, social security, etc.)</label>
                        <textarea id="otherIncome" name="otherIncome" rows="3" placeholder="Child support: $500/month, Investment dividends: $200/month" maxlength="500"></textarea>
                        <div class="character-count" id="otherIncomeCount">0/500 characters</div>
                    </div>
                    
                    <h3>Previous Employment (if less than 1 year at current job)</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="previousEmployer">Previous Employer</label>
                            <input type="text" id="previousEmployer" name="previousEmployer" placeholder="XYZ Company">
                        </div>
                        <div class="form-col">
                            <label for="previousPosition">Position</label>
                            <input type="text" id="previousPosition" name="previousPosition" placeholder="Junior Developer">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="previousEmploymentDates">Employment Dates</label>
                            <input type="text" id="previousEmploymentDates" name="previousEmploymentDates" placeholder="MM/YYYY - MM/YYYY">
                        </div>
                        <div class="form-col">
                            <label for="previousSupervisor">Supervisor Name</label>
                            <input type="text" id="previousSupervisor" name="previousSupervisor" placeholder="Michael Thompson">
                        </div>
                    </div>
                    
                    <div class="save-progress">
                        <button type="button" class="save-progress-btn" id="saveProgressBtn3">
                            <i class="fas fa-save"></i> Save Progress & Continue Later
                        </button>
                    </div>
                    
                    <div class="btn-container">
                        <button type="button" class="btn-prev" onclick="prevSection(3)">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button type="button" class="btn-next" onclick="nextSection(3)">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Section 4: Financial & References -->
                <div class="form-section" id="section4">
                    <h2><i class="fas fa-file-invoice-dollar"></i> Financial Details & References</h2>
                    
                    <h3>Financial Information</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="bankName">Bank Name</label>
                            <input type="text" id="bankName" name="bankName" placeholder="First National Bank">
                        </div>
                        <div class="form-col">
                            <label for="accountType">Account Type</label>
                            <select id="accountType" name="accountType">
                                <option value="">Select Type</option>
                                <option value="Checking">Checking</option>
                                <option value="Savings">Savings</option>
                                <option value="Both">Both</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="outstandingDebts">Outstanding Debts (loans, car payments, credit cards)</label>
                        <textarea id="outstandingDebts" name="outstandingDebts" rows="3" placeholder="Auto loan: $350/month, Student loan: $200/month" maxlength="500"></textarea>
                        <div class="character-count" id="outstandingDebtsCount">0/500 characters</div>
                    </div>
                    
                    <h3>Legal History</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="bankruptcy" name="bankruptcy">
                        <label for="bankruptcy">Any bankruptcies in the past 7 years?</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="evictions" name="evictions">
                        <label for="evictions">Any evictions in the past 7 years?</label>
                    </div>
                    
                    <div id="legalExplanation" style="display: none;">
                        <div class="form-group">
                            <label for="legalDetails">Please provide details</label>
                            <textarea id="legalDetails" name="legalDetails" rows="3" placeholder="Please explain the circumstances..." maxlength="500"></textarea>
                            <div class="character-count" id="legalDetailsCount">0/500 characters</div>
                        </div>
                    </div>
                    
                    <h3>Personal References</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="reference1Name" class="required">Reference 1 Name</label>
                            <input type="text" id="reference1Name" name="reference1Name" placeholder="Michael Brown" required>
                            <div class="error-message" id="reference1NameError">Please enter reference name</div>
                        </div>
                        <div class="form-col">
                            <label for="reference1Relationship" class="required">Relationship</label>
                            <input type="text" id="reference1Relationship" name="reference1Relationship" placeholder="Friend" required>
                            <div class="error-message" id="reference1RelationshipError">Please enter relationship</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="reference1Phone" class="required">Phone Number</label>
                            <input type="tel" id="reference1Phone" name="reference1Phone" placeholder="(555) 789-0123" required maxlength="14">
                            <div class="field-hint">Format: (XXX) XXX-XXXX (10 digits total)</div>
                            <div class="error-message" id="reference1PhoneError">Please enter a valid 10-digit phone number</div>
                        </div>
                        <div class="form-col">
                            <label for="reference1YearsKnown" class="required">Years Known</label>
                            <input type="number" id="reference1YearsKnown" name="reference1YearsKnown" min="1" placeholder="5" required>
                            <div class="error-message" id="reference1YearsKnownError">Please enter years known</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="reference2Name">Reference 2 Name</label>
                            <input type="text" id="reference2Name" name="reference2Name" placeholder="Jennifer Davis">
                        </div>
                        <div class="form-col">
                            <label for="reference2Relationship">Relationship</label>
                            <input type="text" id="reference2Relationship" name="reference2Relationship" placeholder="Colleague">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="reference2Phone">Phone Number</label>
                            <input type="tel" id="reference2Phone" name="reference2Phone" placeholder="(555) 456-7890" maxlength="14">
                            <div class="field-hint">Format: (XXX) XXX-XXXX (10 digits total)</div>
                        </div>
                        <div class="form-col">
                            <label for="reference2YearsKnown">Years Known</label>
                            <input type="number" id="reference2YearsKnown" name="reference2YearsKnown" min="0" placeholder="3">
                        </div>
                    </div>
                    
                    <h3>Emergency Contact</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="emergencyName" class="required">Name</label>
                            <input type="text" id="emergencyName" name="emergencyName" placeholder="David Wilson" required>
                            <div class="error-message" id="emergencyNameError">Please enter emergency contact name</div>
                        </div>
                        <div class="form-col">
                            <label for="emergencyRelationship" class="required">Relationship</label>
                            <input type="text" id="emergencyRelationship" name="emergencyRelationship" placeholder="Brother" required>
                            <div class="error-message" id="emergencyRelationshipError">Please enter relationship</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="emergencyPhone" class="required">Phone Number</label>
                            <input type="tel" id="emergencyPhone" name="emergencyPhone" placeholder="(555) 321-0987" required maxlength="14">
                            <div class="field-hint">Format: (XXX) XXX-XXXX (10 digits total)</div>
                            <div class="error-message" id="emergencyPhoneError">Please enter a valid 10-digit phone number</div>
                        </div>
                        <div class="form-col">
                            <label for="emergencyAddress">Address</label>
                            <input type="text" id="emergencyAddress" name="emergencyAddress" placeholder="321 Pine Street, Springfield">
                        </div>
                    </div>
                    
                    <div class="save-progress">
                        <button type="button" class="save-progress-btn" id="saveProgressBtn4">
                            <i class="fas fa-save"></i> Save Progress & Continue Later
                        </button>
                    </div>
                    
                    <div class="btn-container">
                        <button type="button" class="btn-prev" onclick="prevSection(4)">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button type="button" class="btn-next" onclick="nextSection(4)">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Section 5: Review & Submit -->
                <div class="form-section" id="section5">
                    <h2><i class="fas fa-clipboard-check"></i> Review & Submit Application</h2>
                    
                    <div class="summary-section">
                        <h3>Application Summary</h3>
                        <div id="applicationSummary"></div>
                    </div>
                    
                    <div class="payment-section">
                        <h3>Application Fee Payment</h3>
                        <p>Application Fee: <strong>$50</strong> (non-refundable)</p>
                        <p>Select Payment Method:</p>
                        <div class="payment-options">
                            <div class="payment-option" id="creditCardOption">
                                <i class="fas fa-credit-card"></i>
                                <div>Credit/Debit Card</div>
                            </div>
                            <div class="payment-option" id="bankTransferOption">
                                <i class="fas fa-university"></i>
                                <div>Bank Transfer</div>
                            </div>
                        </div>
                        
                        <div id="creditCardDetails" style="display: none; margin-top: 20px;">
                            <div class="form-row">
                                <div class="form-col">
                                    <label for="cardNumber" class="required">Card Number</label>
                                    <input type="text" id="cardNumber" name="cardNumber" placeholder="1234 5678 9012 3456">
                                </div>
                                <div class="form-col">
                                    <label for="cardName" class="required">Name on Card</label>
                                    <input type="text" id="cardName" name="cardName" placeholder="John A. Smith">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-col">
                                    <label for="expiryDate" class="required">Expiry Date</label>
                                    <input type="text" id="expiryDate" name="expiryDate" placeholder="MM/YY">
                                </div>
                                <div class="form-col">
                                    <label for="cvv" class="required">CVV</label>
                                    <input type="text" id="cvv" name="cvv" placeholder="123">
                                </div>
                            </div>
                        </div>
                        
                        <div id="bankTransferDetails" style="display: none; margin-top: 20px;">
                            <p>Please transfer the application fee to the following account:</p>
                            <p><strong>Bank:</strong> First National Bank<br>
                            <strong>Account Name:</strong> Choice Properties LLC<br>
                            <strong>Account Number:</strong> 123456789<br>
                            <strong>Routing Number:</strong> 021000021</p>
                            <p>Please include your full name as a reference.</p>
                        </div>
                    </div>
                    
                    <div class="legal-section">
                        <h3><i class="fas fa-gavel"></i> Applicant Certification & Agreement</h3>
                        <p>By submitting this application, I certify that all information provided is true and complete to the best of my knowledge. I understand that any false or misleading information is grounds for denial of this application or termination of any resulting lease.</p>
                        <p>I authorize Choice Properties and their agents to verify all information provided, including but not limited to: obtaining my credit report, criminal history, and contacting my current and previous landlords, employers, and references. <strong>I understand that this authorization is made in compliance with the Fair Credit Reporting Act (FCRA).</strong></p>
                        <p>I acknowledge that my application fee is non-refundable.</p>
                        
                        <div class="form-group">
                            <label for="applicantSignature" class="required">Applicant Signature</label>
                            <input type="text" id="applicantSignature" name="applicantSignature" placeholder="Type your full name as signature" required>
                            <div class="error-message" id="applicantSignatureError">Please provide your signature</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="signatureDate" class="required">Date</label>
                            <input type="date" id="signatureDate" name="signatureDate" required>
                            <div class="error-message" id="signatureDateError">Please enter the date</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="feeAcknowledged" name="feeAcknowledged" required>
                            <label for="feeAcknowledged">I acknowledge that the application fee is non-refundable</label>
                        </div>
                        <div class="error-message" id="feeAcknowledgedError">Please acknowledge the application fee</div>
                    </div>
                    
                    <div class="save-progress">
                        <button type="button" class="save-progress-btn" id="saveProgressBtn5">
                            <i class="fas fa-save"></i> Save Progress & Continue Later
                        </button>
                    </div>
                    
                    <div class="btn-container">
                        <button type="button" class="btn-prev" onclick="prevSection(5)">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button type="button" class="btn-submit" onclick="submitApplication()">
                            <i class="fas fa-paper-plane"></i> Submit Application
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <footer>
            <p>&copy; 2023 Choice Properties. All rights reserved. | Professional Property Management</p>
        </footer>
    </div>
<script>
/* ============================================================
   CONFIG
   ============================================================ */
const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJESB6Fx9LqOGhZfjqRjvwaVM5YyslMRiCBsIBIXsJlxpfMbCNRgYqSPUqgh1U_5M/exec';
const LOCAL_STORAGE_KEY = "choicePropertiesRentalApp";

/* ============================================================
   UTILS
   ============================================================ */
function $(id){ return document.getElementById(id); }
function q(selector){ return document.querySelector(selector); }
function qa(selector){ return Array.from(document.querySelectorAll(selector)); }

function getValue(id) {
  const el = $(id);
  return el ? (el.value || "").trim() : "";
}
function getChecked(id) {
  const el = $(id);
  return el ? !!el.checked : false;
}
function safeText(v){ return (typeof v === 'string') ? v.trim() : v || ''; }

/* ============================================================
   POPULATE STATES (restored)
   ============================================================ */
function populateStates() {
  const states = [
    "AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA",
    "KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ",
    "NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT",
    "VA","WA","WV","WI","WY"
  ];
  const stateSelects = ['dlState','currentState','previousState'];
  stateSelects.forEach(id => {
    const sel = $(id);
    if (!sel) return;
    // Only append if <option> count <=1 to avoid duplicates
    if (sel.options.length <= 1) {
      states.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        sel.appendChild(opt);
      });
    }
  });
}

/* ============================================================
   SECTION DATA COLLECTORS
   ============================================================ */
function getSection1Data() {
  return {
    propertyAddress: getValue("propertyAddress"),
    unitNumber: getValue("unitNumber"),
    moveInDate: getValue("moveInDate"),
    leaseTerm: getValue("leaseTerm"),
    fullName: getValue("fullName"),
    dob: getValue("dob"),
    ssn: getValue("ssn"),
    dlNumber: getValue("dlNumber"),
    dlState: getValue("dlState"),
    phone: getValue("phone"),
    email: getValue("email"),
    maritalStatus: getValue("maritalStatus")
  };
}
function getSection2Data() {
  return {
    numOccupants: getValue("numOccupants"),
    occupantsList: getValue("occupantsList"),
    hasPets: getChecked("hasPets"),
    petType: getValue("petType"),
    petBreed: getValue("petBreed"),
    petWeight: getValue("petWeight"),
    petAge: getValue("petAge"),
    hasServiceAnimal: getChecked("hasServiceAnimal"),
    serviceAnimalTask: getValue("serviceAnimalTask"),
    currentAddress: getValue("currentAddress"),
    currentCity: getValue("currentCity"),
    currentState: getValue("currentState"),
    currentZip: getValue("currentZip"),
    currentLandlord: getValue("currentLandlord"),
    currentLandlordContact: getValue("currentLandlordContact"),
    currentResidenceDates: getValue("currentResidenceDates"),
    currentRent: getValue("currentRent"),
    currentReasonLeaving: getValue("currentReasonLeaving"),
    previousAddress: getValue("previousAddress"),
    previousCity: getValue("previousCity"),
    previousState: getValue("previousState"),
    previousZip: getValue("previousZip")
  };
}
function getSection3Data() {
  return {
    employerName: getValue("employerName"),
    employerAddress: getValue("employerAddress"),
    position: getValue("position"),
    supervisorName: getValue("supervisorName"),
    supervisorContact: getValue("supervisorContact"),
    employmentStart: getValue("employmentStart"),
    income: getValue("income"),
    incomeType: getValue("incomeType"),
    otherIncome: getValue("otherIncome"),
    previousEmployer: getValue("previousEmployer"),
    previousPosition: getValue("previousPosition"),
    previousEmploymentDates: getValue("previousEmploymentDates"),
    previousSupervisor: getValue("previousSupervisor")
  };
}
function getSection4Data() {
  return {
    bankName: getValue("bankName"),
    accountType: getValue("accountType"),
    outstandingDebts: getValue("outstandingDebts"),
    bankruptcy: getChecked("bankruptcy"),
    evictions: getChecked("evictions"),
    legalDetails: getValue("legalDetails"),
    reference1Name: getValue("reference1Name"),
    reference1Relationship: getValue("reference1Relationship"),
    reference1Phone: getValue("reference1Phone"),
    reference1YearsKnown: getValue("reference1YearsKnown"),
    reference2Name: getValue("reference2Name"),
    reference2Relationship: getValue("reference2Relationship"),
    reference2Phone: getValue("reference2Phone"),
    reference2YearsKnown: getValue("reference2YearsKnown"),
    emergencyName: getValue("emergencyName"),
    emergencyRelationship: getValue("emergencyRelationship"),
    emergencyPhone: getValue("emergencyPhone"),
    emergencyAddress: getValue("emergencyAddress")
  };
}
function getSection5Data() {
  const selectedPayment = document.querySelector(".payment-option.selected");
  const paymentMethod = selectedPayment ? selectedPayment.textContent.trim() : "";
  return {
    applicantSignature: getValue("applicantSignature"),
    signatureDate: getValue("signatureDate"),
    feeAcknowledged: getChecked("feeAcknowledged"),
    paymentMethod
  };
}
function getCoApplicants() {
  const sections = qa(".co-applicant-section");
  const arr = [];
  sections.forEach(sec => {
    arr.push({
      fullName: sec.querySelector("[id^='coFullName']")?.value.trim() || "",
      dob: sec.querySelector("[id^='coDob']")?.value.trim() || "",
      ssn: sec.querySelector("[id^='coSsn']")?.value.trim() || "",
      relationship: sec.querySelector("[id^='coRelationship']")?.value.trim() || "",
      phone: sec.querySelector("[id^='coPhone']")?.value.trim() || "",
      email: sec.querySelector("[id^='coEmail']")?.value.trim() || ""
    });
  });
  return arr;
}

/* ============================================================
   SUBMIT HANDLER (frontend) - posts JSON to Apps Script
   ============================================================ */
async function submitApplication() {
  try {
    const data = {
      section1: getSection1Data(),
      section2: getSection2Data(),
      section3: getSection3Data(),
      section4: getSection4Data(),
      section5: getSection5Data(),
      coApplicants: getCoApplicants(),
      files: {
        hasPetVaccinations: !!$('petVaccinations')?.files?.length,
        hasIncomeVerification: !!$('incomeVerification')?.files?.length
      }
    };

    // Basic required checks (extend as needed)
    if (!data.section1.fullName || !data.section1.email) {
      alert("Please fill required fields (Full Name and Email).");
      return;
    }

    const submitBtn = document.querySelector(".btn-submit");
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Submitting...`;
    }

    // === TEST: Bypass CORS to confirm issue ===
const resp = await fetch("https://cors-anywhere.herokuapp.com/" + APP_SCRIPT_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(data)
});

alert(" Request sent via proxy. If your Google Sheet updates, CORS is the issue.");

    if (result.success) {
      clearSavedProgress();

      // hide all save buttons
      qa('.save-progress-btn').forEach(b => b.style.display = 'none');

      const form = $('rentalApplication');
      if (form) form.style.display = 'none';

      const msg = $('successMessage');
      if (msg) {
        msg.style.display = 'block';
        msg.innerHTML += `<p><strong>Application ID:</strong> ${result.applicationId}</p>`;
      }
    } else {
      alert("Submission failed: " + (result.error || "Unknown error"));
    }
  } catch (err) {
    console.error("Submit Error:", err);
    alert("Submission error. Please check network and try again.");
  } finally {
    const submitBtn = document.querySelector(".btn-submit");
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = `<i class="fas fa-paper-plane"></i> Submit Application`;
    }
  }
}

/* ============================================================
   LOCAL SAVE / RESTORE
   ============================================================ */
function setupSaveProgress() {
  qa('.save-progress-btn').forEach(btn => btn.addEventListener('click', saveProgress));
  restoreProgressIfAvailable();
}

function saveProgress() {
  const payload = {
    section1: getSection1Data(),
    section2: getSection2Data(),
    section3: getSection3Data(),
    section4: getSection4Data(),
    section5: getSection5Data(),
    coApplicants: getCoApplicants(),
    timestamp: new Date().toISOString()
  };
  try {
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(payload));
    alert(" Your progress has been saved on this device.");
  } catch (err) {
    console.error("Save error", err);
    alert("Unable to save progress. Please check browser settings.");
  }
}

function restoreProgressIfAvailable() {
  const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
  if (!saved) return;
  try {
    const data = JSON.parse(saved);
    if (!confirm("You have a saved application. Restore it?")) return;
    restoreFormData(data);
    alert(" Saved progress restored.");
  } catch (err) {
    console.error("Restore error", err);
  }
}

function restoreFormData(data) {
  if (!data) return;
  if (data.section1) fillSection(data.section1);
  if (data.section2) fillSection(data.section2);
  if (data.section3) fillSection(data.section3);
  if (data.section4) fillSection(data.section4);
  if (data.section5) fillSection(data.section5);

  if (Array.isArray(data.coApplicants)) {
    const container = $('coApplicantsContainer');
    if (!container) return;
    container.innerHTML = '';
    data.coApplicants.forEach((co, idx) => {
      // trigger add co-applicant
      const addBtn = $('addCoApplicant');
      if (addBtn) addBtn.click();
      const sections = qa('.co-applicant-section');
      const sec = sections[idx];
      if (!sec) return;
      // map values to inputs
      Object.entries(co).forEach(([key,val]) => {
        const idPrefix = 'co' + key.charAt(0).toUpperCase() + key.slice(1);
        const input = sec.querySelector(`[id^='${idPrefix}']`);
        if (input) input.value = val;
      });
    });
  }
}

function fillSection(obj) {
  Object.entries(obj).forEach(([key, val]) => {
    const el = $(key);
    if (!el) return;
    if (el.type === 'checkbox') {
      el.checked = !!val;
      el.dispatchEvent(new Event('change'));
    } else {
      el.value = val || '';
    }
  });
}

function clearSavedProgress() {
  localStorage.removeItem(LOCAL_STORAGE_KEY);
}

/* ============================================================
   ORIGINAL BEHAVIOR FUNCTIONS (kept intact & defensive)
   ============================================================ */

function setupConditionalFields() {
  const hasPets = $('hasPets');
  if (hasPets) hasPets.addEventListener('change', () => {
    const p = $('petDetails'); if (p) p.style.display = hasPets.checked ? 'block' : 'none';
  });

  const hasService = $('hasServiceAnimal');
  if (hasService) hasService.addEventListener('change', () => {
    const s = $('serviceAnimalDetails'); if (s) s.style.display = hasService.checked ? 'block' : 'none';
  });

  const bk = $('bankruptcy'), ev = $('evictions');
  function toggleLegal() {
    const el = $('legalExplanation');
    if (el) el.style.display = ((bk && bk.checked) || (ev && ev.checked)) ? 'block' : 'none';
  }
  if (bk) bk.addEventListener('change', toggleLegal);
  if (ev) ev.addEventListener('change', toggleLegal);
}

function setupCharacterCounters() {
  const ids = ['occupantsList','serviceAnimalTask','currentReasonLeaving','otherIncome','outstandingDebts','legalDetails'];
  ids.forEach(id => {
    const ta = $(id);
    const counter = $(id + 'Count');
    if (!ta || !counter) return;
    ta.addEventListener('input', function() {
      const len = this.value.length;
      const max = this.getAttribute('maxlength') || 500;
      counter.textContent = `${len}/${max} characters`;
      if (len > max * 0.9) { counter.classList.add('error'); counter.classList.remove('warning'); }
      else if (len > max * 0.75) { counter.classList.add('warning'); counter.classList.remove('error'); }
      else { counter.classList.remove('warning','error'); }
    });
    ta.dispatchEvent(new Event('input'));
  });
}

function setupFileUploads() {
  const configs = [
    { uploadId: 'petVaccinationsUpload', fileInputId: 'petVaccinations', fileListId: 'petVaccinationsList' },
    { uploadId: 'incomeVerificationUpload', fileInputId: 'incomeVerification', fileListId: 'incomeVerificationList' }
  ];
  configs.forEach(cfg => {
    const area = $(cfg.uploadId), input = $(cfg.fileInputId), list = $(cfg.fileListId);
    if (!area || !input) return;
    area.addEventListener('click', () => input.click());
    area.addEventListener('dragover', e => { e.preventDefault(); area.style.borderColor = 'var(--secondary)'; area.style.backgroundColor = '#e8f4fc'; });
    area.addEventListener('dragleave', () => { area.style.borderColor = '#ddd'; area.style.backgroundColor = ''; });
    area.addEventListener('drop', e => {
      e.preventDefault(); area.style.borderColor = '#ddd'; area.style.backgroundColor = '';
      if (e.dataTransfer.files.length) { input.files = e.dataTransfer.files; updateFileList(input, list); }
    });
    input.addEventListener('change', () => updateFileList(input, list));
  });
}

function updateFileList(fileInput, fileList) {
  if (!fileList) return;
  fileList.innerHTML = '';
  if (!fileInput || !fileInput.files || fileInput.files.length === 0) return;
  for (let i=0;i<fileInput.files.length;i++){
    const f=fileInput.files[i];
    const item = document.createElement('div'); item.className='file-item';
    item.innerHTML = `<div class="file-name"><i class="fas fa-file"></i><span>${f.name}</span></div><div class="file-remove" data-index="${i}"><i class="fas fa-times"></i></div>`;
    fileList.appendChild(item);
  }
  fileList.querySelectorAll('.file-remove').forEach(btn => {
    btn.addEventListener('click', function(){ removeFile(fileInput, parseInt(this.dataset.index)); updateFileList(fileInput,fileList); });
  });
}
function removeFile(fileInput, index) {
  const dt = new DataTransfer();
  const files = fileInput.files;
  for (let i=0;i<files.length;i++) if (i!==index) dt.items.add(files[i]);
  fileInput.files = dt.files;
}

function setupPaymentOptions() {
  const cc = $('creditCardOption'), bt = $('bankTransferOption');
  const ccDetails = $('creditCardDetails'), btDetails = $('bankTransferDetails');
  if (!cc || !bt) return;
  cc.addEventListener('click', () => { cc.classList.add('selected'); bt.classList.remove('selected'); if (ccDetails) ccDetails.style.display='block'; if (btDetails) btDetails.style.display='none'; });
  bt.addEventListener('click', () => { bt.classList.add('selected'); cc.classList.remove('selected'); if (btDetails) btDetails.style.display='block'; if (ccDetails) ccDetails.style.display='none';});
  // default selection:
  cc.click();
}

function setupCoApplicants() {
  const addButton = $('addCoApplicant'), container = $('coApplicantsContainer');
  if (!addButton || !container) return;
  let coApplicantCount = container.querySelectorAll('.co-applicant-section').length || 0;
  addButton.addEventListener('click', function() {
    coApplicantCount++;
    const sec = document.createElement('div'); sec.className='co-applicant-section'; sec.id=`coApplicant${coApplicantCount}`;
    sec.innerHTML = `
      <div class="co-applicant-header">
        <h3>Co-Applicant ${coApplicantCount}</h3>
        <button type="button" class="remove-co-applicant" data-id="${coApplicantCount}"><i class="fas fa-times"></i></button>
      </div>
      <div class="form-row">
        <div class="form-col">
          <label for="coFullName${coApplicantCount}" class="required">Full Legal Name</label>
          <input type="text" id="coFullName${coApplicantCount}" name="coFullName${coApplicantCount}" required>
        </div>
        <div class="form-col">
          <label for="coDob${coApplicantCount}" class="required">Date of Birth</label>
          <input type="date" id="coDob${coApplicantCount}" name="coDob${coApplicantCount}" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-col">
          <label for="coSsn${coApplicantCount}" class="required">Social Security Number</label>
          <div class="ssn-container">
            <input type="password" id="coSsn${coApplicantCount}" name="coSsn${coApplicantCount}" placeholder="XXX-XX-XXXX" maxlength="11" required>
            <button type="button" class="ssn-toggle" data-target="coSsn${coApplicantCount}"><i class="fas fa-eye"></i> Show</button>
          </div>
        </div>
        <div class="form-col">
          <label for="coDlNumber${coApplicantCount}" class="required">Driver's License / State ID Number</label>
          <input type="text" id="coDlNumber${coApplicantCount}" name="coDlNumber${coApplicantCount}" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-col">
          <label for="coDlState${coApplicantCount}" class="required">Issuing State</label>
          <select id="coDlState${coApplicantCount}" name="coDlState${coApplicantCount}" required>
            <option value="">Select State</option>
          </select>
        </div>
        <div class="form-col">
          <label for="coPhone${coApplicantCount}" class="required">Phone Number</label>
          <input type="tel" id="coPhone${coApplicantCount}" name="coPhone${coApplicantCount}" maxlength="14" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-col">
          <label for="coEmail${coApplicantCount}" class="required">Email Address</label>
          <input type="email" id="coEmail${coApplicantCount}" name="coEmail${coApplicantCount}" required>
        </div>
        <div class="form-col">
          <label for="coRelationship${coApplicantCount}">Relationship</label>
          <input type="text" id="coRelationship${coApplicantCount}" name="coRelationship${coApplicantCount}">
        </div>
      </div>
    `;
    container.appendChild(sec);

    // populate state select inside new co-applicant
    const coState = $(`coDlState${coApplicantCount}`);
    if (coState) {
      const states = ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];
      states.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; coState.appendChild(o); });
    }

    // setup ssn toggle for this section
    const ssnToggle = sec.querySelector('.ssn-toggle');
    const ssnInput = sec.querySelector(`#coSsn${coApplicantCount}`);
    if (ssnToggle && ssnInput) {
      ssnToggle.addEventListener('click', function() {
        toggleSSNVisibility(ssnInput, this);
      });
      ssnInput.addEventListener('input', function(){ formatSSN(this); });
    }

    // phone formatting
    const phoneInput = sec.querySelector(`#coPhone${coApplicantCount}`);
    if (phoneInput) phoneInput.addEventListener('input', function(){ formatPhoneNumber(this); });

    // remove button
    const removeBtn = sec.querySelector('.remove-co-applicant');
    if (removeBtn) removeBtn.addEventListener('click', function(){
      const id = this.dataset.id;
      const el = $(`coApplicant${id}`);
      if (el) el.remove();
    });
  });
}

/* ============================================================
   VALIDATION & FORM HELPERS (kept from original, defensive)
   ============================================================ */
function setupRealTimeValidation() {
  const emailField = $('email'); if (emailField) emailField.addEventListener('blur', function(){ validateEmail(this); });
  const phoneField = $('phone'); if (phoneField) phoneField.addEventListener('blur', function(){ validatePhoneNumber(this); });
  const ssnField = $('ssn'); if (ssnField) ssnField.addEventListener('blur', function(){ validateSSN(this); });
  const ref1Phone = $('reference1Phone'); if (ref1Phone) ref1Phone.addEventListener('blur', function(){ validatePhoneNumber(this); });
  const emergencyPhone = $('emergencyPhone'); if (emergencyPhone) emergencyPhone.addEventListener('blur', function(){ validatePhoneNumber(this); });
}
function validateEmail(input) {
  const email = input.value;
  const emailError = $('emailError');
  if (email && !isValidEmail(email)) {
    if (emailError) { emailError.textContent = 'Please enter a valid email address'; emailError.style.display = 'block'; }
    input.classList.add('error');
  } else {
    if (emailError) emailError.style.display = 'none';
    input.classList.remove('error');
  }
}
function isValidEmail(email) {
  const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
  return re.test(String(email).toLowerCase());
}
function validatePhoneNumber(input) {
  const phone = (input.value || '').replace(/\D/g,'');
  let errorElement = input.parentElement.querySelector('.error-message');
  if (!errorElement) {
    errorElement = document.createElement('div'); errorElement.className = 'error-message'; input.parentElement.appendChild(errorElement);
  }
  if (phone && phone.length !== 10) {
    errorElement.textContent = 'Please enter a valid 10-digit phone number'; errorElement.style.display = 'block';
    input.classList.add('error');
  } else {
    errorElement.style.display = 'none'; input.classList.remove('error');
  }
}
function validateSSN(input) {
  const ssn = input.value || '';
  const ssnRegex = /^\d{3}-\d{2}-\d{4}$/;
  const ssnError = $('ssnError');
  if (ssn && !ssnRegex.test(ssn)) {
    if (ssnError) { ssnError.style.display = 'block'; }
    input.classList.add('error');
  } else {
    if (ssnError) ssnError.style.display = 'none';
    input.classList.remove('error');
  }
}

/* ============================================================
   SSN Masking & Phone Formatting
   ============================================================ */
function setupSSNMasking() {
  const ssnToggle = $('ssnToggle');
  const ssnInput = $('ssn');
  if (ssnToggle && ssnInput) {
    ssnToggle.addEventListener('click', function(){
      toggleSSNVisibility(ssnInput, this);
    });
    ssnInput.addEventListener('input', function(){ formatSSN(this); });
  }
}
function toggleSSNVisibility(input, button) {
  if (!input) return;
  if (input.type === 'password') {
    input.type = 'text';
    if (button) button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
  } else {
    input.type = 'password';
    if (button) button.innerHTML = '<i class="fas fa-eye"></i> Show';
  }
}
function formatSSN(input) {
  if (!input) return;
  let v = input.value.replace(/\D/g,'').slice(0,9);
  if (v.length >= 6) v = `${v.slice(0,3)}-${v.slice(3,5)}-${v.slice(5)}`;
  else if (v.length >= 4) v = `${v.slice(0,3)}-${v.slice(3)}`;
  input.value = v;
}

function setupPhoneFormatting() {
  const phoneIds = ['phone','reference1Phone','emergencyPhone'];
  phoneIds.forEach(id => {
    const el = $(id);
    if (el) el.addEventListener('input', function(){ formatPhoneNumber(this); });
  });
  // dynamic co-applicant phones handled in co-applicant setup
}
function formatPhoneNumber(input) {
  if (!input) return;
  let v = (input.value || '').replace(/\D/g,'').slice(0,10);
  if (v.length >= 7) v = `(${v.slice(0,3)}) ${v.slice(3,6)}-${v.slice(6)}`;
  else if (v.length >= 4) v = `(${v.slice(0,3)}) ${v.slice(3)}`;
  else if (v.length > 0) v = `(${v}`;
  input.value = v;
}

/* ============================================================
   PROGRESS BAR & NAVIGATION (basic, preserved)
   ============================================================ */
function updateProgressBar() {
  const sections = qa('.form-section');
  if (!sections.length) return;
  let activeIndex = sections.findIndex(s => s.classList.contains('active'));
  if (activeIndex < 0) activeIndex = 0;
  const fill = $('progressFill');
  const pct = Math.round((activeIndex) / (sections.length - 1) * 100);
  if (fill) fill.style.width = pct + '%';
  // mark steps
  qa('.progress-step').forEach((step,i)=>{
    step.classList.remove('active','completed');
    if (i < activeIndex) step.classList.add('completed');
    if (i === activeIndex) step.classList.add('active');
  });
}

function nextSection(current) {
  const sections = qa('.form-section');
  if (!sections.length) return;
  // find current by id
  const cur = $(`section${current}`);
  if (!cur) return;
  cur.classList.remove('active');
  const next = $(`section${current+1}`);
  if (next) next.classList.add('active');
  updateProgressBar();
}
function prevSection(current) {
  const cur = $(`section${current}`);
  if (!cur) return;
  cur.classList.remove('active');
  const prev = $(`section${current-1}`);
  if (prev) prev.classList.add('active');
  updateProgressBar();
}

/* ============================================================
   INIT
   ============================================================ */
document.addEventListener('DOMContentLoaded', function() {
  // keep original initializations (but ensure safe)
  populateStates();
  setupConditionalFields();
  setupCharacterCounters();
  setupFileUploads();
  setupPaymentOptions();
  setupCoApplicants();
  setupSaveProgress();          // our localStorage save/restore + binds save buttons
  setupRealTimeValidation();
  setupSSNMasking();
  setupPhoneFormatting();

  // set min dates
  const today = new Date().toISOString().split('T')[0];
  if ($('moveInDate')) $('moveInDate').min = today;
  if ($('signatureDate')) $('signatureDate').value = today;

  updateProgressBar();
});
</script>
</body>
</html>